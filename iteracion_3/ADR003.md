# **Iteración 3**

## **ADR 003**

### **Titulo**

Escalabilidad del Modulo de Pedidos

**Motivación**

La motivación para la escalabilidad en el módulo de **pedidos** radica en garantizar que el sistema pueda manejar un volumen creciente de solicitudes sin sacrificar rendimiento ni experiencia de usuario. Un diseño escalable permite responder eficazmente a picos de carga, mantener alta disponibilidad, y adaptarse al crecimiento del negocio. Esto asegura una experiencia confiable, evita cuellos de botella, y optimiza el rendimiento general del sistema, permitiendo la gestión de transacciones críticas y el manejo de concurrencia con consistencia.

**Drivers elegidos:** Escalabilidad y modularización de Pedidos.

**Justificación:** Este driver ha sido seleccionado debido a que existen 3 etapas de Pedidos que pueden explotarse para obetener escalabilidad horizontal y una comunicación entre ellos que garantice eficiencia al momento de que el cliente realice un pedido, sin perder sincronización.

**Meta:** Diseñar una arquitectura de microservicios que permita al sistema manejar un gran volumen de datos y transacciones incluso en momentos de alta demanda, sin perder rendimiento y manteniendo la usabilidad.

**Componente a refinar**: Módulo de Pedidos.

## **Decisión principal**

### **Cadena de Responsabilidades + Balanceador de Carga**

### **Cadena de Responsabilidades**

Aplicado al módulo de **Pedidos**, la cadena de responsabilidades implica que cada fase del proceso de un pedido (preprocesado, autorización y aceptación) se gestione por un microservicio específico. Cada microservicio actúa como un eslabón en la cadena, pasando la tarea al siguiente solo cuando se completa la fase actual.

**Desacoplamiento y Escalabilidad**:

- Cada microservicio es independiente y puede escalar de forma autónoma en función de la carga de trabajo específica de su fase. Por ejemplo, si la fase de *autorización* requiere más recursos debido a un mayor volumen de solicitudes, solo este microservicio necesita escalarse, no toda la cadena.
- Esto permite una mejor gestión de los recursos y la posibilidad de ajustar la infraestructura según las necesidades de cada etapa.

**Comunicación entre los Microservicios**

Se optó por el uso de un sistema de sincronización Message Queue implementado con Kafka para la comunicación entre las etapas de procesamiento de un pedido para una solución escalable y robusta. 

Este mecanismo se utiliza principalmente para construir sistemas de mensajería que permiten la creación y el manejo de flujos de datos en tiempo real de forma eficiente, segura y escalable.

**Características de Kafka**

- Permite que múltiples productores publiquen mensajes en **tópicos** y que múltiples consumidores se suscriban a esos tópicos para recibir los mensajes en tiempo real.
- Almacena mensajes en disco y permite la persistencia duradera de estos, lo que permite a los consumidores leer mensajes en diferentes momentos y re-procesar flujos de datos si es necesario.
- Está diseñado para escalar horizontalmente, lo que significa que se pueden añadir más servidores (nodos) a un clúster para aumentar la capacidad de procesamiento y almacenamiento.
- Maneja millones de mensajes por segundo con baja latencia, lo que lo hace ideal para gestionar pedidos en tiempo real..

**Persistencia**

Para desacoplar las etapas y que aumentar la escalabilidad, decidimos que cada microservicio tenga su propia base de datos.

**Base de Datos Microservicio de Pedidos**:

- La base de datos asociada a este microservicio gestionaría la información básica del pedido, como el ID del pedido, detalles del cliente, productos solicitados, estado del pedido, etc.

**Base de Datos Microservicio de Preprocesado**:

- Este servicio tiene una base de datos para almacenar los resultados del preprocesado, como la disponibilidad del stock, precios calculados, y otras verificaciones previas.

**Base de Datos Microservicio de Autorización**:

- Tiene una base de datos para almacenar la información relacionada con la autorización de pagos o el historial de autorizaciones para un pedido.

**Base de Datos Microservicio de Aceptación**:

- Este servicio almacena el estado final del pedido, si el pedido fue aceptado, la fecha de aceptación, etc.

**Flujo de Ejecución de un Pedido**

1. **Selección del Pedido**
    - El sistema principal de Pedidos gestiona el carrito de compras del cliente. Cuando el cliente confirma que quiere realizar la compra, se delega el pedido al microservicio de Preprocesamiento.
2. **Publicación del Pedido**:
    - El microservicio de **Preprocesado** recibe un nuevo pedido y valida sus datos. Una vez validado, publica un mensaje `PedidoPreprocesado` en el tópico `preprocesado-pedidos`.
3. **Consumo por la Etapa de Autorización**:
    - El microservicio de **Autorización** está suscrito al tópico `preprocesado-pedidos` y consume el mensaje `PedidoPreprocesado`.
    - Procesa la autorización (verifica la identidad del cliente y los intentos permitidos). Si la autorización es exitosa, publica un mensaje `PedidoAutorizado` en el tópico `autorizacion-pedidos`.
4. **Consumo por la Etapa de Aceptación**:
    - El microservicio de **Aceptación** está suscrito al tópico `autorizacion-pedidos` y consume el mensaje `PedidoAutorizado`.
    - Procesa la aceptación del pedido y, una vez completada la fase, publica un mensaje `PedidoAceptado` en el tópico `aceptacion-pedidos`.
5. **Notificación Final y Persistencia**:
    - El modulo de pago estará suscrito al tópico `aceptacion-pedidos` para concretar el pago de los pedidos que ya pasaron por las tres etapas.

Cada etapa actúa como **consumidor** del tópico anterior y **productor** del tópico siguiente, asegurando un flujo ordenado y desacoplado.
